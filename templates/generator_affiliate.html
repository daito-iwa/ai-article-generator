<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI記事生成 - 無料でSEO最適化記事を作成</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50">

<!-- ヘッダー -->
<nav class="bg-white shadow-lg sticky top-0 z-50">
    <div class="max-w-7xl mx-auto px-4">
        <div class="flex justify-between items-center py-4">
            <a href="/" class="text-2xl font-bold text-gray-800">AI記事生成ツール</a>
            <div class="flex items-center space-x-4">
                <div class="text-sm">
                    本日の利用: <span class="font-bold">{{ usage }}/{{ daily_limit }}記事</span>
                </div>
            </div>
        </div>
    </div>
</nav>

<!-- メインコンテンツ -->
<div class="max-w-7xl mx-auto px-4 py-8">
    
    <!-- 利用状況 -->
    <div class="bg-white rounded-lg shadow-lg p-6 mb-8">
        <h2 class="text-xl font-bold mb-4">本日の利用状況</h2>
        
        <div class="mb-4">
            <div class="flex justify-between mb-2">
                <span>利用可能数</span>
                <span class="font-bold text-lg">残り{{ remaining }}記事</span>
            </div>
            <div class="bg-gray-200 rounded-full h-3">
                <div class="bg-green-600 h-3 rounded-full transition-all duration-300" 
                     style="width: {{ (usage / daily_limit * 100)|int }}%"></div>
            </div>
        </div>
        
        {% if not can_use %}
        <div class="bg-red-50 border-2 border-red-300 rounded-lg p-4">
            <p class="text-red-700 font-semibold">本日の無料利用枠に達しました</p>
            <p class="text-sm text-red-600 mt-1">明日0時にリセットされます</p>
        </div>
        {% else %}
        <div class="bg-green-50 border-2 border-green-300 rounded-lg p-4">
            <p class="text-green-700 font-semibold">記事を生成できます！</p>
        </div>
        {% endif %}
    </div>

    <div class="grid lg:grid-cols-2 gap-8">
        
        <!-- 記事生成フォーム -->
        <div class="bg-white rounded-lg shadow-lg p-6">
            <h2 class="text-xl font-bold mb-4">記事生成</h2>
            
            <form id="articleForm" class="space-y-4">
                <div>
                    <label class="block text-gray-700 text-sm font-bold mb-2">
                        キーワード <span class="text-red-500">*</span>
                    </label>
                    <input type="text" 
                           id="keyword" 
                           name="keyword"
                           class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:border-blue-500" 
                           placeholder="例: AI 記事 生成" 
                           required
                           {% if not can_use %}disabled{% endif %}>
                    <p class="text-xs text-gray-600 mt-1">記事のメインキーワードを入力してください</p>
                </div>
                
                <div>
                    <label class="block text-gray-700 text-sm font-bold mb-2">文字数</label>
                    <select id="length" 
                            name="length"
                            class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:border-blue-500"
                            {% if not can_use %}disabled{% endif %}>
                        <option value="1000">1,000文字程度</option>
                        <option value="1500" selected>1,500文字程度</option>
                        <option value="2000">2,000文字程度</option>
                        <option value="2500">2,500文字程度</option>
                    </select>
                </div>
                
                <div>
                    <label class="block text-gray-700 text-sm font-bold mb-2">文体</label>
                    <select id="tone" 
                            name="tone"
                            class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:border-blue-500"
                            {% if not can_use %}disabled{% endif %}>
                        <option value="friendly" selected>親しみやすい</option>
                        <option value="professional">専門的</option>
                        <option value="casual">カジュアル</option>
                    </select>
                </div>
                
                <div class="space-y-2">
                    <div class="flex items-center">
                        <input type="checkbox" 
                               id="includeFaq" 
                               name="include_faq"
                               checked 
                               class="mr-2"
                               {% if not can_use %}disabled{% endif %}>
                        <label for="includeFaq" class="text-gray-700 text-sm">FAQセクションを含める</label>
                    </div>
                    
                    <div class="flex items-center">
                        <input type="checkbox" 
                               id="includeAffiliate" 
                               name="include_affiliate"
                               checked 
                               class="mr-2"
                               {% if not can_use %}disabled{% endif %}>
                        <label for="includeAffiliate" class="text-gray-700 text-sm">
                            おすすめツールを紹介する
                            <span class="text-xs text-gray-500">（アフィリエイトリンク）</span>
                        </label>
                    </div>
                </div>
                
                <button type="submit" 
                        id="generateBtn" 
                        class="w-full bg-blue-600 text-white py-3 rounded-lg hover:bg-blue-700 transition-colors font-semibold disabled:bg-gray-400 disabled:cursor-not-allowed"
                        {% if not can_use %}disabled{% endif %}>
                    {% if can_use %}
                        無料で記事を生成する
                    {% else %}
                        本日の利用枠終了
                    {% endif %}
                </button>
            </form>
            
            <div id="generationStatus" class="mt-4 text-center text-gray-600 hidden">
                <div class="animate-spin inline-block w-6 h-6 border-2 border-current border-t-transparent rounded-full mr-2"></div>
                記事を生成中...（約30-60秒）
            </div>
        </div>
        
        <!-- キーワードリサーチ -->
        <div class="bg-white rounded-lg shadow-lg p-6">
            <h2 class="text-xl font-bold mb-4">トレンドキーワード提案</h2>
            
            <form id="keywordForm" class="space-y-4">
                <div>
                    <label class="block text-gray-700 text-sm font-bold mb-2">取得件数</label>
                    <select id="keywordLimit" 
                            name="limit"
                            class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:border-blue-500">
                        <option value="5">5件</option>
                        <option value="10" selected>10件</option>
                        <option value="20">20件</option>
                    </select>
                </div>
                
                <button type="submit" 
                        id="researchBtn" 
                        class="w-full bg-green-600 text-white py-3 rounded-lg hover:bg-green-700 transition-colors font-semibold">
                    トレンドキーワードを調査
                </button>
            </form>
            
            <div id="keywordResults" class="mt-6 hidden">
                <h3 class="font-semibold mb-3">調査結果</h3>
                <div id="keywordList" class="space-y-2"></div>
            </div>
            
            <!-- ヒント -->
            <div class="mt-6 bg-blue-50 rounded-lg p-4">
                <h4 class="font-semibold text-blue-800 mb-2">💡 記事作成のヒント</h4>
                <ul class="text-sm text-blue-700 space-y-1">
                    <li>• トレンドキーワードを使うとアクセスが集まりやすい</li>
                    <li>• 複合キーワード（2-3語）の方が上位表示しやすい</li>
                    <li>• 読者の悩みを解決する内容にする</li>
                </ul>
            </div>
        </div>
    </div>
    
    <!-- 生成された記事 -->
    <div id="articleResult" class="bg-white rounded-lg shadow-lg p-6 mt-8 hidden">
        <div class="flex justify-between items-center mb-4">
            <h2 class="text-xl font-bold">生成された記事</h2>
            <div class="space-x-2">
                <button onclick="copyArticle()" class="bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600">
                    コピー
                </button>
                <button onclick="downloadArticle()" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">
                    ダウンロード
                </button>
            </div>
        </div>
        
        <!-- 記事メタ情報 -->
        <div class="bg-gray-50 rounded-lg p-4 mb-6">
            <div class="grid md:grid-cols-4 gap-4 text-sm">
                <div>
                    <span class="font-semibold">文字数:</span>
                    <span id="resultWordCount">-</span>
                </div>
                <div>
                    <span class="font-semibold">キーワード密度:</span>
                    <span id="resultKeywordDensity">-</span>%
                </div>
                <div>
                    <span class="font-semibold">SEOスコア:</span>
                    <span id="resultSeoScore">-</span>/100
                </div>
                <div>
                    <span class="font-semibold">生成時刻:</span>
                    <span id="resultGenerationTime">-</span>
                </div>
            </div>
        </div>
        
        <!-- 記事タイトル -->
        <div class="mb-4">
            <label class="block text-gray-700 text-sm font-bold mb-2">タイトル</label>
            <input type="text" id="resultTitle" class="w-full px-3 py-2 border rounded-lg bg-gray-50" readonly>
        </div>
        
        <!-- メタディスクリプション -->
        <div class="mb-4">
            <label class="block text-gray-700 text-sm font-bold mb-2">メタディスクリプション</label>
            <textarea id="resultMetaDescription" class="w-full px-3 py-2 border rounded-lg bg-gray-50 h-20" readonly></textarea>
        </div>
        
        <!-- 記事本文 -->
        <div class="mb-4">
            <label class="block text-gray-700 text-sm font-bold mb-2">記事本文</label>
            <textarea id="resultContent" class="w-full px-3 py-2 border rounded-lg bg-gray-50" rows="20" readonly></textarea>
        </div>
        
        <!-- 使い方のヒント -->
        <div class="bg-yellow-50 border-2 border-yellow-300 rounded-lg p-4 mt-4">
            <h4 class="font-semibold text-yellow-800 mb-2">📌 生成された記事の活用方法</h4>
            <ul class="text-sm text-yellow-700 space-y-1">
                <li>1. 記事をコピーしてWordPressなどのブログに投稿</li>
                <li>2. 必要に応じて画像を追加して見やすくする</li>
                <li>3. アフィリエイトリンクはそのまま使用可能（削除も自由）</li>
                <li>4. 公開前に事実確認を行う</li>
            </ul>
        </div>
    </div>
</div>

<script>
// 記事生成フォーム
document.getElementById('articleForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const formData = new FormData(e.target);
    const generateBtn = document.getElementById('generateBtn');
    const status = document.getElementById('generationStatus');
    
    generateBtn.disabled = true;
    status.classList.remove('hidden');
    
    try {
        const response = await fetch('/api/generate-article', {
            method: 'POST',
            body: formData
        });
        
        const result = await response.json();
        
        if (result.success) {
            displayArticle(result.article);
            updateUsageDisplay(result.usage);
            
            // 成功通知
            alert('記事生成完了！下にスクロールして確認してください。');
            
            // 結果にスクロール
            document.getElementById('articleResult').scrollIntoView({ behavior: 'smooth' });
        } else {
            alert(result.detail || '記事生成に失敗しました');
        }
        
    } catch (error) {
        console.error('記事生成エラー:', error);
        alert('記事生成中にエラーが発生しました');
    } finally {
        generateBtn.disabled = false;
        status.classList.add('hidden');
    }
});

// キーワードリサーチフォーム
document.getElementById('keywordForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const formData = new FormData(e.target);
    const researchBtn = document.getElementById('researchBtn');
    
    researchBtn.disabled = true;
    researchBtn.textContent = '調査中...';
    
    try {
        const response = await fetch('/api/research-keywords', {
            method: 'POST',
            body: formData
        });
        
        const result = await response.json();
        
        if (result.success) {
            displayKeywords(result.keywords);
        } else {
            alert('キーワード取得に失敗しました');
        }
        
    } catch (error) {
        console.error('キーワード調査エラー:', error);
        alert('キーワード調査中にエラーが発生しました');
    } finally {
        researchBtn.disabled = false;
        researchBtn.textContent = 'トレンドキーワードを調査';
    }
});

// 記事表示
function displayArticle(article) {
    document.getElementById('resultTitle').value = article.title;
    document.getElementById('resultMetaDescription').value = article.meta_description;
    document.getElementById('resultContent').value = article.content;
    document.getElementById('resultWordCount').textContent = article.word_count.toLocaleString();
    document.getElementById('resultKeywordDensity').textContent = article.keyword_density.toFixed(2);
    document.getElementById('resultSeoScore').textContent = article.seo_score.toFixed(1);
    
    const now = new Date();
    document.getElementById('resultGenerationTime').textContent = 
        `${now.getHours()}:${now.getMinutes().toString().padStart(2, '0')}`;
    
    document.getElementById('articleResult').classList.remove('hidden');
}

// キーワード表示
function displayKeywords(keywords) {
    const keywordList = document.getElementById('keywordList');
    keywordList.innerHTML = '';
    
    keywords.forEach(kw => {
        const div = document.createElement('div');
        div.className = 'flex justify-between items-center p-3 border rounded-lg hover:bg-gray-50 cursor-pointer';
        div.onclick = () => {
            document.getElementById('keyword').value = kw.keyword;
        };
        
        div.innerHTML = `
            <div>
                <div class="font-semibold">${kw.keyword}</div>
                <div class="text-xs text-gray-500">関連: ${kw.related_keywords.join(', ')}</div>
            </div>
            <div class="text-right">
                <div class="text-sm font-semibold text-blue-600">スコア: ${kw.trend_score.toFixed(1)}</div>
            </div>
        `;
        
        keywordList.appendChild(div);
    });
    
    document.getElementById('keywordResults').classList.remove('hidden');
}

// 利用状況更新
function updateUsageDisplay(usage) {
    // ページをリロードして最新の利用状況を表示
    if (usage.remaining === 0) {
        alert('本日の無料利用枠に達しました。明日またご利用ください。');
        setTimeout(() => location.reload(), 2000);
    } else {
        setTimeout(() => location.reload(), 1000);
    }
}

// 記事コピー
function copyArticle() {
    const title = document.getElementById('resultTitle').value;
    const content = document.getElementById('resultContent').value;
    const meta = document.getElementById('resultMetaDescription').value;
    
    const fullArticle = `# ${title}\n\n${content}\n\n---\n\nメタディスクリプション: ${meta}`;
    
    navigator.clipboard.writeText(fullArticle).then(() => {
        alert('記事をクリップボードにコピーしました！');
    });
}

// 記事ダウンロード
function downloadArticle() {
    const title = document.getElementById('resultTitle').value;
    const content = document.getElementById('resultContent').value;
    const meta = document.getElementById('resultMetaDescription').value;
    
    const fullArticle = `# ${title}\n\n${content}\n\n---\n\nメタディスクリプション: ${meta}`;
    
    const blob = new Blob([fullArticle], { type: 'text/markdown' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `${title.replace(/[^a-zA-Z0-9ぁ-んァ-ヶー一-龠]/g, '_')}.md`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
}
</script>

</body>
</html>